

# 第十六章 微程序控制

## KEY POINTS

1. 微指令、微程序、控制字的定义。什么是水平微指令和垂直微指令？
2. 微程序控制器的组成。微程序控制器和硬连线控制器的优缺点各是什么？
3. 微程序控制器进行一次控制的步骤。

> 易俊泉学长的原始笔记链接如下：
>
> [chapter16 微程序控制](docs/课内笔记/大三上/计算机组成与结构/笔记/易俊泉/chapter16微程序控制.md)

## 基本概念

从上一章最后的硬编码公式中可以看到，将输入信号->输出信号的函数使用硬件实现是很困难的。因此，我们可以创建一门描述控制的语言，称为微程序控制语言；之后，我们只需要为此语言实现一个编译器（把此语言编写的逻辑映射为硬件实现），就可以使用此语言，从更高层的视角上设计硬件了。

### 微指令

**微程序控制语言 microprogramming language**：指定微操作的语言，**每行描述一个时间内出现的一组微操作**，称为一条**微指令 microinstruction**

**微程序/固件**：若干条指令组成的序列，实现特定操作所需的指令。它存储到只读存储中，是硬件和软件之间的中间环节（编写难度小于硬件设计，大于软件开发）

**控制字 control word**：用于控制的 “0,1” 序列，每种序列对应一个微操作。

序列中的每一个 0/1 都指定一个控制门是否开启，比如控制下图中的一个 Cx。

![image-20241118173825440](https://telegraph-image-5ms.pages.dev/file/BQACAgUAAyEGAASIfjD1AANCZ6F7PT0pk_FN0TXhOHlWX52CpuUAAqoSAAK0lBBVEaW1nB-r0JE2BA.png)

**如何使用微程序概念来实现控制器呢:question:**

> 考虑到对于每个微操作，控制器所做的全部事情就是产生一组控制信号。对任一微操作，控制器发出的每根控制线或开或关。自然，对应这种情况，每根控制线可由一个二进制数字表示。这样，我们就构造了**一个控制字（control word），其中每位代表一根控制线，从而每个微操作能用控制字中的不同的0和1的式样来表示。**

**微指令类型**

垂直微指令：每个微指令指定要执行的单个（或几个）微操作，具有如下特点：

- 宽度较窄 
- n 位控制信号可以使用 log2n 位进行编码
- 由于编码问题，表达并行性的能力有限
- 很少使用

> ![image-20211201103646326](https://raw.githubusercontent.com/yijunquan-afk/img-bed-1/main/img2/1695704551.png)

水平微指令：每个微指令指定要并行执行的许多不同的微操作

每位都可以编码一个微操作是否执行。

> 比较宽 
> 可实现高度并行操作 
> 控制信息的编码很少
>
> ![image-20211201103952812](https://raw.githubusercontent.com/yijunquan-afk/img-bed-1/main/img2/1695704552.png)

### 微程序控制器

**微程序控制器的组成**

> **控制存储器（control memory）**存有一组微指令
>
> **控制地址寄存器（control address register）**含有下面即将被读取的微指令地址；当一条微指令由控制存储器读出后，即被传送到控制缓冲寄存器（类似 MAR 或者 PC）
>
> **缓冲寄存器(control buffer register)。**此寄存器的左半部分与控制器发出的控制线相连接。于是，由控制存储器读一条微指令等同于执行这条微指令。（类似 MBR）
>
> 图中所示左侧的是**排序单元（sequencing unit）**（图中称为「定序逻辑」），它向控制地址寄存器装入地址并发出读命令。
>
> ![image-20211201104752774](https://raw.githubusercontent.com/yijunquan-afk/img-bed-1/main/img2/1695704553.png)

**控制器的功能**

> :one: 为执行一条指令，定序逻辑发出一个读命令给控制存储器。
> :two: 控制地址寄存器指定的一个字读人到控制缓冲寄存器。
> :three: 控制缓冲寄存器的内容生成控制信号，并为定序逻辑提供下一条地址信息。
> :four: 定序逻辑根据这个地址信息和ALU标志，将一个新地址装人到控制地址寄存器。所有这些事情都发生在一个时钟周期内。

![image-20211201105540040](https://raw.githubusercontent.com/yijunquan-afk/img-bed-1/main/img2/1695704554.png)

对于第四步，在每条微指令结束时，定序逻辑都要将一个新的地址装入控制地址寄存器，取决于ALU标志和控制缓冲寄存器的内容，要做如下决策：

> **取顺序下一条微指令**：控制地址寄存器的值 +1。
> **跳转到其他微指令（取决于是否存在额外周期，比如间指/中断周期）**：将控制缓冲寄存器的地址字段装入控制地址寄存器。
> **转移到一个机器指令例程**：根据 IR 中的操作码向控制地址寄存器装入机器指令例程的第一条微指令。

**微程序设计的优缺点**

> 简化控制单元的设计
> 便宜 不易出错 
> 比硬连线控制慢 
> 微程序设计是当代CISC中实现控制单元的主要技术 硬连线控制主要用于RISC

## 微指令排序

微指令排序的设计考虑

> :one: 微指令大小
>
> 减小微指令的大小就能节省控制存储器的成本
>
> :two: 地址生成时间
>
> 生成时间要尽可能短，这样才能满足尽快执行微指令的要求
>
> :three: 下一条微指令地址来源
>
> 由指令寄存器决定\下一个顺序地址\转移

下一微指令的地址必须根据当前微指令、条件标志、和IR的内容来生成

根据微指令中的地址信息的格式，可将转移控制逻辑分为：

> 双地址字段、单地址字段、可变格式

![image-20211227161944224](https://raw.githubusercontent.com/yijunquan-afk/img-bed-1/main/img2/1695704555.png)