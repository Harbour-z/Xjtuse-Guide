

# 第十八章 多核计算机

## KEY POINTS

1. 多核的定义

2. 多核出现的必然性：硬件性能问题和并行需求

3. 几种线程级并行方法，SMT 技术的定义

4. 多核中 Cache 的几种设计方法，共享二级 Cache 的优点

> 易俊泉学长的原始笔记链接如下：
>
> [chapter18 多核计算机](docs/课内笔记/大三上/计算机组成与结构/笔记/易俊泉/chapter18多核计算机.md)

多核计算机也称为单芯片多处理器，指在一个单独的硅片上**结合两个或多个处理器**（称为核）。

多核要求一片芯片上存在**多个 CU**。

为了满足多个核心的需求，多核 CPU 通常需要更大的 cache，确保多个处理器都能正确处理。

## 硬件性能问题

### 功耗 power dissipation

功耗与芯片的密度和时钟频率成指数级的正相关。也就是说，时钟频率增加到 x 倍，功耗可能就会增加到 $e^x$ 倍。

#### 散热问题Heat Dissipation Problem

散热是几个因素的函数，其中两个是处理器密度和时钟速度：是直接成比例影响的

在传统架构中，热量的增加大于时钟频率的增加幅度。因此对于高性能的 CPU，需要使用液体辅助散热，比如硅管或者海水散热。

一种控制功率密度的方法是：降低 CPU 面积中逻辑门的密度，增加 CPU 面积，并增加更多的 Cache 区域。这是因为 Cache 的发热少于逻辑门，可以缓和一点发热。

为了利用引入的大块 Cache，可以使用多核技术，确保所有 Cache 都能得到使用。

**Pollack 规则（经验规则）**：性能增长与复杂度增加的平方根成比例。

> 比如 CPU 的复杂度增加到 2 倍，那么其性能大概只增加到 1.414 倍。

散热要求**芯片密度和时钟频率低**->多核是唯一的选择

因为多核中，性能增加和能耗增加几乎为线性关系，比如 1 个核消耗 80w，两个核大概就消耗 160w，比增加 CPU 的密度/时钟频率所增加的功耗需求少。

### 并行需要

SMT：同时多线程处理，多线程共享超标量资源

随着超标量的宽度和深度的增加，需要更多的逻辑来管理指令冲突，并将指令分为各个阶段，增加流水线段数的收益递减。

因此，为了提高指令级并行度而不增加复杂性，增加核心数量是唯一选择。

对于大型网站、数据库等应用，一般的指令级并行是不够的。这些程序因为同时需要服务的用户很多，需要更高的并行性。

> 指令级并行：指令间相互重叠就是指令级并行。因此，任意阶段数的流水线、超标量都是指令级并行。

TLP：线程级并行

- 线程是一段独立的进程或者程序片段，拥有自己的指令和数据，但和某个进程共享部分资源。线程拥有自己的线程控制块，有自己的 PC 指针，部分寄存器……
- 线程级并行：只要有多于一个线程在同时执行，就是线程级并行
- 在一个线程因为 I/O 等原因停顿时，可以执行其他线程
- 线程之间的指令相关性很小，因此同时执行时几乎不会产生冲突。

多线程允许多个线程以交叠的方式同时使用 CPU。

- CPU 为每个线程维护单独的状态信息（PC，寄存器等信息）

多线程有如下几种：

- 细粒度多线程：在每条指令执行时轮流切换线程，采用循环调度方式

  在某条线程执行需要几个时钟周期的操作时，换入另一个线程，先执行新线程一段时间。

- 粗粒度多线程：仅当一个线程需要等待较长时间（比如访问内存/磁盘）时，切换线程。切换时，清空超标量的所有流水线，换入另一个可执行的线程，重新流入。
- 混合多线程：某些情况下使用细粒度多线程，某些情况下使用粗粒度的。

> 发射宽度：执行段的个数

细粒度多线程：每个时间片必须切换正在执行的线程。下图中，每一个时间片 A 和 B 都进行轮换。可以减少垂直浪费。

粗粒度多线程：一个线程一直运行，直到它需要长时间等待，比如访问内存，才切换线程。也可以解决垂直浪费。

不过，两种方法都不能解决水平浪费，因为每个时刻本质上都只有一个线程在执行，A 和 B 不能在一行中（同一时刻）都执行。SMT 解决了这一问题。

![image-20211208101405904](https://raw.githubusercontent.com/yijunquan-afk/img-bed-1/main/img2/1695704570.png)

在某个时刻，如果发射宽度没有占满，就会出现「水平浪费」

因为资源冲突等原因导致执行部件在某段时间出现空间，称为「垂直浪费」。

> 垂直浪费要求一整行都是空的；因此，上面两张图中都没有垂直浪费。

SMT：允许单个时间内执行多个线程。

SMT 相对传统多线程，存在多个 CU，寄存器和 ALU，因此从硬件上就支持多个线程一同执行（上面的机器从硬件上就决定了无法同时执行两个线程，因为 CU 不够）

![image-20211208101528637](https://raw.githubusercontent.com/yijunquan-afk/img-bed-1/main/img2/1695704571.png)

下图表示了普通超标量、细粒度多线程、粗粒度多线程和 SMT 对 CPU 时钟周期的利用率。从左到右依次为超标量，细粒度多线程（每个时间片切换一次线程），粗粒度多线程和 SMT。

![image-20211208102437894](https://raw.githubusercontent.com/yijunquan-afk/img-bed-1/main/img2/1695704572.png)

但是，SMT 也存在问题：支持 SMT 的 CPU 比普通的 CPU 复杂太多，造价昂贵更多，因此它并没有成为主流的技术。

成为主流的是多核 CPU： 每个核都可以独立的执行一个线程，但一个核不能同时执行多个线程。多核 CPU 的复杂性不高，造价相比 SMT 低不少，因此成为了主流。

目前大部分多核处理器也可以使用 SMT 技术：因为每个核的发射宽度不算大，调度难度相比一般 SMT 低，因此并不算复杂。

### 多核框架

![image-20211208103209678](https://raw.githubusercontent.com/yijunquan-afk/img-bed-1/main/img2/1695704574.png)

共享二级 Cache 和共享三级 Cache。

#### 共享二级cache优点

建设冲突（数据共享）可以降低整体未命中率

>  一个内核上的线程访问主内存位置会导致块传输到共享缓存
>
>  如果另一个内核上的线程很快访问相同的内存块，它将命中，不需要访问内存了。
>
>  建设冲突出现的越多越好。

 多个内核共享的数据不会在共享缓存级别复制，大家都使用同一份共享缓存。

 分配给每个核心的共享缓存量是动态的

>  位置较少的线程可以使用更多缓存

 通过共享缓存，可以轻松实现核心间通信

 共享 L2 高速缓存将高速缓存一致性问题限制在 L1 高速缓存级别（只需要处理 L1 Cache 中可能存在的不同步问题）



重点：为什么要走到多核

- 有哪些线程级并行
- 什么是 SMT
- 多核的组织架构有哪几种（共享几级缓存？）

