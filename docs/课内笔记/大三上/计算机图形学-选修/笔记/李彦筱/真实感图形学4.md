# 第四章 真实感图形学(4)——高级着色模型和光线追踪

> 此部分内容是新扩展的，相对没那么重要。

## 着色模型

### 着色模型的定义

着色模型只取决于法线、观察方向和光照方向，即只是这三者的函数。这是因为一个物体表面反射光的情况只取决于这三者（即反射的三要素）

Phong 模型的不足：不能较好的模拟漫反射（粗糙表面的反射）。

这是因为 Phong 模型中的漫反射光线是在半球面内均匀分布的，但是漫反射实际上应当是向各个方向无规律反射的，因此不是这样的简单模型能描述的。

我们需要描述物体表面的微小平面，才能完整的模拟漫反射。如何模拟呢？

工业界常用「Cook-Torrance」模型，包含一个固定的平均漫反射项（和 Phong 类似），和由多个函数相乘构成的微表面高光。

### 菲涅尔现象

菲涅尔现象：**物体表面在不同入射光角度下，反射光线的强度不同。**

比如，对于一个物体在桌子上的镜面反射，反射影子越高的位置应当越淡（反射越少，更模糊），越低（越接近原本物体）应当越大（更清晰），整个倒影不应当是相同模糊程度的。

在 grazing angle（和原先物体平面相切）的入射角时，反射现象最为明显。

实际上，我们不会存储微观表面并进行计算，不然怕不是要 RTX60 系列除了也算不了）。实际使用近似估计。

物体的表面看起来粗糙还是光滑，并不取决于微表面的数量，而是取决于微表面的分布。表面分布的越均匀，看起来越光滑。

法线分布函数 NDF：表示微表面法线分布的集中还是分散，如果很集中则反射强，聚集于一点；如果法线分散则反射弱，看上去像粗糙的。

D(m) 的限制：D(m) 对所有微表面的积分大于宏表面的面积，即微表面的总面积 > 宏表面的面积

Geometry Term（G）函数通过定义遮挡，消除了 Grazing Angle 下的部分光强；没有此项的话，grazing angle 下的反射光强会非常强，强到不符合实际了）

### Disney Principled BRDF

上面这种计算公式太难了，不是专业人士根本不会用，那有没有什么一键开启反射的模型呢？

Disney（就是米老鼠的迪士尼）在 2012 年提出了 BRDF 模型，主要在 Cook-Torrance 模型的基础上，重新建立一套参数，然后建立新的参数到原先参数的映射体系。

新的参数包含：

- 固有色、次表面、金属度、镜面反射强度、镜面反射颜色等内容

这些参数虽然也比较专业，但比之前模型中的复杂参数好多了，符合物理直观。现在非专业人士（建模师等）也能轻松通过这些参数控制材质表现了。

现代的游戏引擎都支持这样的参数，只需要拖动调整参数大小，就可以简单的实现好看、真实的反射效果。

## 光线追踪

光线追踪是在二维屏幕上呈现三维图像的方法（不仅是追踪光线如何多次反射的方法）

这样的工作和光栅化是类似的，那为什么还需要光线追踪呢？

- 光栅化难以表达全局效果，比如软阴影和光线的多次反射

光栅化只是快速的近似，结果质量较差；光线追踪结果更准确，但是速度更慢。

实现方法：**光线投射**

1. 人眼向投影平面上每一个像素（注意是按照二维平面而不是三维空间查询）发出一条光线，判断其和模型的交点，只选择最近的交点。

2. 连接交点和光源，判断连线上是否存在物体就知道此像素/交点是否在阴影中。

3. 这条发射的光线也可以在模型上发生反射和折射，反射/折射后的光线还可以继续碰撞物体。我们把所有反射/折射时得到的交点全部收集起来，实际像素的光线就是各种可行光路交点的着色值按照权重相加。

> 光线追踪不追踪光源发出的光线，只追踪屏幕像素发射的光线。
>
> 这是因为光源发出的绝大部分光线最终都不会落到相机处，计算光源发出的光线大概率会浪费算力。
>
> 而且根据光路可逆，从相机开始发光、光源接受光的光路和相机接受光源发出光的光路是完全相同的，因此反着算也不会错。

引入包围盒可以加速光线是否和物体相交的计算过程。包围盒是包裹了物体整个模型的立方体，计算光线是否可以和包围盒相交，代替是否和物体相交。由于长方体是很简单的模型，这样的计算开销远小于一大堆三角面片的模型。